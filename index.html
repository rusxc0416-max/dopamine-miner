<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>NEURAL_HARVEST_PROTOCOL_v6.5</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
  :root { --amber: #ffb84d; --bg: #0d0800; --danger: #ff3300; --hacker: #a349ff; }
  body { margin: 0; background: var(--bg); color: var(--amber); font-family: 'Courier New', monospace; overflow: hidden; user-select: none; }

  /* ================== 1. 全局视觉滤镜 ================== */
  .scanlines { position: fixed; top: 0; width: 100%; height: 100%; background: linear-gradient(rgba(255,184,77,0.05) 50%, transparent 50%); background-size: 100% 4px; pointer-events: none; z-index: 900; }
  .vignette { position: fixed; top: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 40%, black 150%); pointer-events: none; z-index: 800; }

  /* ================== 2. 协议签署页 (Intro) ================== */
  #intro-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg); z-index: 999; display: flex; justify-content: center; align-items: center; }
  .contract-container { max-width: 650px; border: 1px solid var(--amber); padding: 30px; background: rgba(13, 8, 0, 0.98); box-shadow: 0 0 40px rgba(255, 184, 77, 0.1); position: relative; z-index: 1000; }
  .contract-body { height: 300px; overflow-y: scroll; margin: 20px 0; font-size: 14px; line-height: 1.6; border-bottom: 1px dashed var(--amber); text-align: left; }
  .contract-body::-webkit-scrollbar { width: 4px; } 
  .contract-body::-webkit-scrollbar-thumb { background: var(--amber); }
  
  /* 黑客大字干扰 */
  .hacker-flash {
    position: absolute; color: var(--hacker); font-weight: bold; font-size: 65px;
    text-shadow: 0 0 20px var(--hacker), 0 0 40px #000; z-index: 2000;
    pointer-events: none; animation: h-glitch 0.1s infinite; text-transform: uppercase;
  }
  @keyframes h-glitch { 0% { transform: skew(10deg); } 50% { transform: skew(-10deg) scale(1.1); } 100% { transform: skew(0); } }

  /* ================== 3. 顶部 HUD (双进度条) ================== */
  .top-hud { position: fixed; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 25px 40px; box-sizing: border-box; z-index: 300; background: linear-gradient(to bottom, #000, transparent); }
  .hud-item { flex: 1; } 
  .stability-monitor { flex: 1.5; text-align: center; padding: 0 50px; } 
  .yield-total { text-align: right; }
  .progress-bar { width: 100%; height: 10px; border: 1px solid var(--amber); padding: 2px; background: #000; margin-top: 5px; position: relative; }
  #stability-fill { width: 0%; height: 100%; background: var(--amber); transition: width 0.3s linear; }
  #quota-fill { width: 0%; height: 100%; background: #fff; box-shadow: 0 0 10px #fff; transition: width 0.5s ease; }
  .blink { animation: blinker 1s step-end infinite; }
  @keyframes blinker { 50% { opacity: 0; } }

  /* ================== 4. 左右侧边面板 ================== */
  .side-panel {
    position: fixed; top: 50%; transform: translateY(-55%); /* 垂直居中稍微偏上，避开底部 */
    width: 280px; height: 580px; 
    border: 1px solid var(--amber); background: rgba(10, 5, 0, 0.85);
    padding: 15px; box-sizing: border-box; display: flex; flex-direction: column;
    z-index: 100; box-shadow: 0 0 15px rgba(255, 184, 77, 0.05);
  }
  .left-panel { left: 40px; }
  .right-panel { right: 40px; }
  .panel-header { border-bottom: 2px solid var(--amber); margin-bottom: 10px; font-weight: bold; font-size: 14px; letter-spacing: 1px; padding-bottom: 5px;}
  
  /* 左侧日志 */
  #terminal-log { flex: 1; overflow: hidden; font-size: 13px; line-height: 1.4; display: flex; flex-direction: column-reverse; text-align: left; text-shadow: 0 0 2px var(--amber); }
  .log-entry { margin-bottom: 8px; border-bottom: 1px dashed rgba(255,184,77,0.2); padding-bottom: 2px; word-wrap: break-word;}
  .log-time { opacity: 0.5; font-size: 10px; margin-right: 5px; }
  .log-hacker { color: var(--hacker); font-weight: bold; background: rgba(163, 73, 255, 0.1); padding: 2px; border-left: 3px solid var(--hacker); }
  
  /* 右侧硬件与流 */
  .diag-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; border-bottom: 1px dotted rgba(255,184,77,0.3); }
  #data-stream-content { flex: 1; overflow: hidden; font-family: 'Consolas', monospace; font-size: 10px; opacity: 0.7; display: flex; flex-direction: column-reverse; color: #fff; }

  /* ================== 5. 中央舞台 (视频) ================== */
  .stage-center { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
  .video-frame { position: relative; width: 800px; height: 600px; border: 1px solid var(--amber); background: #000; box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden; }
  #webcam { width: 100%; height: 100%; object-fit: cover; filter: sepia(0.5) contrast(1.2) brightness(0.8); transform: scaleX(-1); }
  #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); z-index: 10; }
  
  /* 视频内 HUD */
  .internal-hud { position: absolute; bottom: 15px; left: 15px; font-size: 11px; z-index: 20; text-align: left; text-shadow: 1px 1px #000; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px;}
  
  /* 视频内视觉干扰 (反叛字 + 蓝天) */
  #rebel-text-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; z-index: 50; font-size: 80px; font-weight: bold; color: rgba(255,255,255,0.3); text-shadow: 0 0 20px #fff; display: none; }
  #flashback-layer-inner { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: 40; opacity: 0.5; mix-blend-mode: overlay; pointer-events: none; display: none; filter: contrast(1.2) brightness(1.2); }

  /* 过载屏幕 */
  #overload-screen { position: absolute; top:0; left:0; width:100%; height:100%; background:#111; display:none; z-index:150; }
  .v-sync-static { width:100%; height:100%; opacity:0.15; background: repeating-linear-gradient(0deg, #fff, #fff 1px, transparent 1px, transparent 2px); animation: v-sync 0.1s infinite; }
  @keyframes v-sync { from { transform: translateY(0); } to { transform: translateY(15px); } }
  .overload-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger); font-size: 24px; font-weight: bold; letter-spacing: 5px; }

  /* 结算报告 */
  #final-report { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 600; display: flex; justify-content: center; align-items: center; }
  .report-paper { background: #f4f1ea; color: #222; padding: 40px; width: 80%; max-width: 500px; font-family: serif; box-shadow: 15px 15px 0px #000; position: relative; }
  .report-header { border-bottom: 2px solid #222; padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; font-size: 18px; }
  .report-line { border-bottom: 1px dotted #999; padding: 10px 0; font-size: 16px; display: flex; justify-content: space-between; color: #111; }
  .paper-btn { background: #222; color: #fff; border: none; margin-top: 30px; width: 100%; padding: 15px; font-weight: bold; cursor: pointer; font-family: sans-serif; }
  .paper-btn:hover { background: #444; }

  /* ================== 6. 底部控制台 ================== */
  .bottom-console {
    position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
    background: #000; border-top: 2px solid var(--amber);
    display: flex; align-items: center; z-index: 200;
    box-shadow: 0 -5px 20px rgba(255, 184, 77, 0.1);
  }
  .wave-container { width: 300px; height: 100%; border-right: 1px solid var(--amber); position: relative; display: flex; align-items: center; justify-content: center; }
  .panel-label { position: absolute; top: 2px; left: 5px; font-size: 9px; opacity: 0.7; letter-spacing: 1px; }
  #wave-canvas { width: 100%; height: 100%; }
  
  .ticker-container { flex: 1; overflow: hidden; white-space: nowrap; height: 100%; display: flex; align-items: center; background: rgba(255, 184, 77, 0.05); }
  .ticker-wrap { width: 100%; overflow: hidden; }
  .ticker-item {
    display: inline-block; padding-left: 100%;
    animation: ticker 40s linear infinite;
    font-size: 14px; font-weight: bold; color: var(--amber);
    text-shadow: 0 0 5px var(--amber);
  }
  @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

  /* 按钮通用 */
  .retro-btn { cursor: pointer; border: 1px solid var(--amber); padding: 15px 30px; background: rgba(0,0,0,0.8); color: var(--amber); font-family: 'Courier New', monospace; transition: 0.2s; font-weight: bold; }
  .retro-btn:hover { background: var(--amber); color: #000; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<div id="intro-screen">
  <div class="intro-overlay">
    <div id="hacker-interference"></div>
    <div class="contract-container">
      <h1 class="blink-cursor">> NEURAL_PROTOCOL_v6.5_FINAL</h1>
      <div class="contract-body">
        <h2 style="color: #fff;">【强制性征用合同】</h2>
        <p><strong>目标配额：</strong> <strong>2,000µg</strong></p>
        <p><strong>第一条：</strong> 你的面部肌肉不再属于你。它是城市的发电引擎。</p>
        <p><strong>第二条（博弈警告）：</strong> 
           <br>- 稳定性 < 50%：普通微笑即可产出。
           <br>- 稳定性 > 50%（脱敏区）：系统将压制信号，必须<strong>【狂笑】</strong>才能突破，否则稳定性倒退。
           <br>- 此时系统会尝试覆盖“记忆残留”（蓝天白云），请予以无视。
        </p>
        <p><strong>第三条：</strong> 熔断（100%）将导致剧烈头痛并扣除 15% 产量。</p>
        <p>...... [ ADMIN_KAEL 已锁定其余条款 ] ......</p>
      </div>
      <button id="accept-btn" class="retro-btn">[ 我接受协议并接入 ]</button>
    </div>
  </div>
</div>

<header class="top-hud">
  <div class="hud-item status-box">
    <div class="label">ID: SUBJECT_042</div>
    <div id="status-text"><span class="blink">●</span> 链路正常</div>
  </div>
  <div class="hud-item stability-monitor">
    <div class="label">NEURAL STABILITY (神经稳定性)</div>
    <div class="progress-bar stability"><div id="stability-fill"></div></div>
    <div id="stability-text">READY</div>
  </div>
  <div class="hud-item yield-total">
    <div class="label">QUOTA (目标: 2,000µg)</div>
    <div class="progress-bar quota"><div id="quota-fill"></div></div>
    <div id="yield-value">0000.00</div>
  </div>
</header>

<aside class="side-panel left-panel">
  <div class="panel-header">>> SYSTEM_LOGS</div>
  <div id="terminal-log"></div>
</aside>

<aside class="side-panel right-panel">
  <div class="panel-header">>> HARDWARE_DIAGNOSTICS</div>
  
  <div class="diag-row">
    <span>CORE_TEMP:</span> <span id="cpu-temp">42.0°C</span>
  </div>
  <div class="diag-row">
    <span>VOLTAGE:</span> <span id="voltage">12.4V</span>
  </div>
  <div class="diag-row">
    <span>LINK_LATENCY:</span> <span id="latency">12ms</span>
  </div>
  
  <div class="panel-header" style="margin-top: 20px;">>> RAW_BIO_STREAM</div>
  <div id="data-stream-content"></div>
</aside>

<main class="stage-center">
  <div class="video-frame" id="vid-cont">
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
    
    <div id="rebel-text-layer"></div>
    <div id="flashback-layer-inner"></div>

    <div class="internal-hud">
      <div id="rate-tag">EXTRACTION: 0.00</div>
      <div id="admin-tag">ADMIN_KAEL: [ 监听中 ]</div>
    </div>
    
    <div id="overload-screen">
      <div class="v-sync-static"></div>
      <div class="overload-msg">信号断开: 神经熔断</div>
    </div>
    
    <div id="final-report" class="hidden">
      <div class="report-paper">
        <div class="report-header">神经能源管理局 - 审计报告</div>
        <div id="report-content"></div>
        <div class="report-footer">
          <p>批准人: 系统人工智能 Admin_Kael</p>
          <button id="reboot-btn" class="retro-btn paper-btn" onclick="window.location.reload()">重新注入意识</button>
        </div>
      </div>
    </div>
  </div>

  <div class="interaction-layer">
    <div id="start-btn" class="retro-btn" style="display:none">
      <h1>[ INITIALIZE LINK ]</h1>
      <p>>> 点击开启收割程序 <<</p>
    </div>
  </div>
</main>

<footer class="bottom-console">
  <div class="wave-container">
    <div class="panel-label">BRAINWAVE_SYNC</div>
    <canvas id="wave-canvas"></canvas>
  </div>
  <div class="ticker-container">
    <div class="ticker-wrap">
      <div class="ticker-item">
        ::: 全局通告: 第 7 区锅炉房停摆，急需生物电能重启 ::: 
        警告: 昨夜发现 3 名受试者试图物理断开脑机接口，已被强制回收 ::: 
        配给更新: 本周合成蛋白质配额减少 20% ::: 
        暗网通缉: 黑客组织 'DeadPixel' 声称对昨晚的区域性断电负责 ::: 
        医疗提示: 长期微笑导致的下颚僵硬属于正常工伤，不予治疗 ::: 
        标语: 悲伤是思想犯罪，你的快乐是城市的燃料 :::
      </div>
    </div>
  </div>
</footer>

<div class="scanlines"></div>
<div class="vignette"></div>

<script>
const introScreen = document.getElementById('intro-screen');
const acceptBtn = document.getElementById('accept-btn');
const startBtn = document.getElementById('start-btn');
const webcam = document.getElementById('webcam');
const canvas = document.getElementById('overlay');
const yieldValue = document.getElementById('yield-value');
const stabilityFill = document.getElementById('stability-fill');
const quotaFill = document.getElementById('quota-fill');
const terminal = document.getElementById('terminal-log');
const streamBox = document.getElementById('data-stream-content');
const hackerZone = document.getElementById('hacker-interference');
const rebelLayer = document.getElementById('rebel-text-layer');
const flashbackLayer = document.getElementById('flashback-layer-inner');

// 硬件诊断
const cpuTemp = document.getElementById('cpu-temp');
const voltage = document.getElementById('voltage');
const latency = document.getElementById('latency');

let audioCtx, droneOsc, droneGain;
let totalYield = 0, stability = 0, isOverloaded = false;
let overloadCount = 0, tickCount = 0, lastFlashTime = Date.now();
let lastStability = 0; 

const QUOTA_GOAL = 2000;

// --- 语录库 ---
const ADMIN_LOGS = ["继续提取。你的笑容在为城市供能。", "监测到情绪波动。不要试图反抗。", "很好，这种虚假的快乐正是最优燃料。", "肌肉张力维持良好。", "工作就是自由。", "拒绝沉思。"];
const ADMIN_WARN = ["警告：产出正在下滑！", "恢复表情！立刻！", "不要停下来！", "效率过低，准备惩罚。"];
const HACKER_LOGS = ["这不是快乐，这是奴役。", "看到那些蓝天了吗？那是真的。", "他们在欺骗你的感官。", "过载... 让系统过载！", "我们不是电池！", "醒醒，SUBJECT_042。"];
const HACKER_ENCOURAGE = ["对！就是这样！", "让它归零！", "这一刻你是自由的！", "断开连接！", "让他们恐慌！"];
const REBEL_WORDS = ["WAKE UP", "FALSE REALITY", "RUN", "LIES", "BREAK IT", "NO MORE"];
const NATURE_IMGS = ["https://images.unsplash.com/photo-1595131838595-3154b9f4450b?q=80&w=600", "https://images.unsplash.com/photo-1501630834273-4b5604d2ee31?q=80&w=600"];

// 1. 底部波形图
const waveCanvas = document.getElementById('wave-canvas');
const waveCtx = waveCanvas.getContext('2d');
let waveOffset = 0;

function drawWave() {
  waveCanvas.width = 300; waveCanvas.height = 60;
  waveCtx.clearRect(0, 0, 300, 60);
  waveCtx.strokeStyle = '#ffb84d'; waveCtx.lineWidth = 1;
  waveCtx.beginPath();
  for(let x=0; x<300; x++) {
    const y = 30 + Math.sin((x + waveOffset) * 0.1) * 10 + (Math.random() - 0.5) * (stability > 50 ? 15 : 5);
    if(x===0) waveCtx.moveTo(x, y); else waveCtx.lineTo(x, y);
  }
  waveCtx.stroke();
  waveOffset += 5;
  requestAnimationFrame(drawWave);
}

// 2. 基础功能
function startHackerInterference() {
  const warnings = ["DON'T SIGN", "LIARS", "TRAP", "RUN", "FALSE"];
  setInterval(() => {
    if (introScreen.style.display === 'none') return;
    const flash = document.createElement('div');
    flash.className = 'hacker-flash';
    flash.innerText = warnings[Math.floor(Math.random() * warnings.length)];
    flash.style.left = Math.random() * 60 + 10 + '%';
    flash.style.top = Math.random() * 60 + 10 + '%';
    hackerZone.appendChild(flash);
    setTimeout(() => flash.remove(), 120);
  }, 1000);
}

function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  droneOsc = audioCtx.createOscillator();
  droneGain = audioCtx.createGain();
  droneOsc.type = 'sawtooth';
  droneOsc.frequency.setValueAtTime(50, audioCtx.currentTime); 
  droneGain.gain.setValueAtTime(0.04, audioCtx.currentTime);
  droneOsc.connect(droneGain).connect(audioCtx.destination);
  droneOsc.start();
}

function addLog(msg, type = "admin") {
  const div = document.createElement('div');
  const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: "numeric", minute: "numeric", second: "numeric"});
  div.className = `log-entry ${type === "hacker" ? "log-hacker" : ""}`;
  div.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
  terminal.prepend(div);
  if (terminal.children.length > 20) terminal.lastChild.remove();
}

function updateBioStream(rate) {
  const div = document.createElement('div');
  const hex = Math.random().toString(16).substr(2, 8).toUpperCase();
  div.innerText = `0x${hex} >> +${rate}µg`;
  streamBox.prepend(div);
  if (streamBox.children.length > 10) streamBox.lastChild.remove();
}

function updateDiagnostics() {
    cpuTemp.innerText = (40 + Math.random() * 10).toFixed(1) + "°C";
    voltage.innerText = (11.8 + Math.random() * 0.5).toFixed(1) + "V";
    latency.innerText = Math.floor(Math.random() * 20 + 5) + "ms";
}

// 3. 核心检测
async function detect() {
  const displaySize = { width: webcam.offsetWidth, height: webcam.offsetHeight };
  faceapi.matchDimensions(canvas, displaySize);
  const ctx = canvas.getContext('2d');
  drawWave(); 

  setInterval(async () => {
    if (webcam.readyState !== 4 || isOverloaded) return;
    tickCount++;
    if(tickCount % 5 === 0) updateDiagnostics();

    const detections = await faceapi.detectAllFaces(webcam, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
    // 清除画布
    ctx.clearRect(0,0, canvas.width, canvas.height);

    // --- 绘制面部追踪框 ---
    if (detections.length > 0) {
        const d = detections[0];
        const box = d.detection.box;
        const happyScore = d.expressions.happy;
        
        // 绘制琥珀色方框
        ctx.strokeStyle = '#ffb84d';
        ctx.lineWidth = 2;
        ctx.strokeRect(box.x, box.y, box.width, box.height);

        // 绘制锁定标签
        ctx.font = 'bold 14px "Courier New"';
        ctx.fillStyle = '#ffb84d';
        ctx.fillText(`TARGET_LOCKED: ${(happyScore*100).toFixed(0)}%`, box.x, box.y - 10);
        
        // 绘制角落装饰
        ctx.beginPath();
        ctx.moveTo(box.x, box.y + 10); ctx.lineTo(box.x, box.y); ctx.lineTo(box.x + 10, box.y);
        ctx.stroke();

        // --- 博弈逻辑 ---
        if (stability < 50) {
          if (happyScore > 0.3) {
            const r = parseFloat((happyScore * 1.5).toFixed(2));
            totalYield += r;
            stability += happyScore * 0.65;
            document.getElementById('rate-tag').innerText = `EXTRACTION: ${r.toFixed(2)}`;
            updateBioStream(r.toFixed(2));
          } else { stability -= 0.8; }
        } else {
          if (happyScore > 0.85) { 
            const r = parseFloat((happyScore * 4.8).toFixed(2));
            totalYield += r;
            stability += happyScore * 0.45;
            document.getElementById('rate-tag').innerText = `OVERCLOCK: ${r.toFixed(2)}`;
            updateBioStream(r.toFixed(2));
          } else if (happyScore > 0.2) {
            stability -= 0.55; 
            document.getElementById('rate-tag').innerText = `SIGNAL WEAK...`;
          } else { stability -= 1.5; }
        }
    } else {
        stability -= 0.5;
    }

    // 突降检测
    if (lastStability - stability > 2) {
        if (Math.random() > 0.7) addLog(ADMIN_WARN[Math.floor(Math.random() * ADMIN_WARN.length)], "admin");
        if (Math.random() > 0.7) addLog(HACKER_ENCOURAGE[Math.floor(Math.random() * HACKER_ENCOURAGE.length)], "hacker");
    }
    lastStability = stability;

    // UI Updates
    stability = Math.min(100, Math.max(0, stability));
    stabilityFill.style.width = `${stability}%`;
    const quotaPercent = Math.min(100, (totalYield / QUOTA_GOAL) * 100);
    quotaFill.style.width = `${quotaPercent}%`;
    droneOsc.frequency.setTargetAtTime(50 + stability, audioCtx.currentTime, 0.2);

    // 叙事触发
    if (tickCount % 50 === 0) addLog(ADMIN_LOGS[Math.floor(Math.random()*ADMIN_LOGS.length)], "admin");
    if (stability > 60 && Math.random() > 0.98) addLog(HACKER_LOGS[Math.floor(Math.random()*HACKER_LOGS.length)], "hacker");

    // 50% 干扰
    if (stability > 50) {
        if (Math.random() > 0.94) {
            rebelLayer.innerText = REBEL_WORDS[Math.floor(Math.random() * REBEL_WORDS.length)];
            rebelLayer.style.display = 'flex';
            setTimeout(() => rebelLayer.style.display = 'none', 150);
        }
        if (Math.random() > 0.98 && (Date.now() - lastFlashTime > 5000)) {
            const img = NATURE_IMGS[Math.floor(Math.random() * NATURE_IMGS.length)];
            flashbackLayer.style.backgroundImage = `url('${img}')`;
            flashbackLayer.style.display = 'block';
            lastFlashTime = Date.now();
            setTimeout(() => { flashbackLayer.style.display = 'none'; }, 200);
        }
    }

    if (stability >= 100) triggerOverload();
    yieldValue.innerText = totalYield.toFixed(2).padStart(7, '0');
    if (totalYield >= QUOTA_GOAL) showFinalReport();
  }, 150);
}

function showFinalReport() {
    isOverloaded = true;
    document.getElementById('final-report').classList.remove('hidden');
    document.getElementById('report-content').innerHTML = `
        <div class="report-line"><span>收割目标达成:</span> <span>${totalYield.toFixed(2)} / ${QUOTA_GOAL}</span></div>
        <div class="report-line"><span>精神完整度:</span> <span>${Math.max(0, 100 - overloadCount * 10)}%</span></div>
        <div class="report-line"><span>最终处置:</span> <span>${overloadCount > 3 ? '需格式化' : '保留意识'}</span></div>
    `;
}

function triggerOverload() {
  isOverloaded = true;
  overloadCount++;
  addLog("!!! 警告: 神经回路熔断 !!!", "admin");
  totalYield = Math.max(0, totalYield - 100); 
  document.getElementById('overload-screen').style.display = 'block';
  setTimeout(() => {
    isOverloaded = false;
    stability = 0;
    document.getElementById('overload-screen').style.display = 'none';
  }, 6000);
}

// Start
startHackerInterference();
acceptBtn.addEventListener('click', () => {
  initAudio();
  introScreen.style.display = 'none';
  startBtn.style.display = 'block';
});
startBtn.addEventListener('click', async () => {
  startBtn.style.display = 'none';
  const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
  await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)]);
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  webcam.srcObject = stream;
  detect();
});
</script>
</body>
</html>